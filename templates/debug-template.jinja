{% for message in messages %}
    {# Print role and tools for debugging #}
    <!-- DEBUG: role={{ message['role'] }}, tools={{ message.get('tools') }} -->

    {% if message['role'] == 'system' and 'tools' in message and message['tools'] is not none %}
        {{ '<|' ~ message['role'] ~ '|>' ~ message['content'] ~ '<|tool|>' ~ message['tools'] ~ '<|/tool|><|end|>' }}
    {% else %}
        {{ '<|' ~ message['role'] ~ '|>' ~ message['content'] ~ '<|end|>' }}
    {% endif %}
{% endfor %}

{% if add_generation_prompt %}
    {{ '<|assistant|>' }}
{% else %}
    {{ eos_token }}
{% endif %}
